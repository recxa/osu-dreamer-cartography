<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Part D: Cross-Validation – Latent Cartography</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Part D: Cross-Validation</h1>
            <p class="subtitle">Validating generalization on held-out test songs</p>
            <a href="index.html" class="back-link" style="display:inline-block;margin-top:1rem;color:#2563eb;text-decoration:none;">← Back to overview</a>
        </header>

        <section style="background:#fff;border-radius:12px;padding:1.5rem;margin-bottom:2rem;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
            <h2 style="margin-bottom:1rem;">Methodology</h2>
            <p style="color:#64748b;margin-bottom:1rem;">
                The original VAE was trained on all 850 mapsets, including the songs used for cross-mapper analysis.
                To validate that the latent space findings reflect genuine learned structure rather than memorization,
                we retrained the VAE on a subset and tested on completely held-out songs.
            </p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-top:1.5rem;">
                <div style="padding:1rem;background:#f8fafc;border-radius:8px;">
                    <div style="font-weight:600;margin-bottom:0.5rem;">Training Set</div>
                    <div style="color:#64748b;font-size:0.875rem;">579 mapsets from 2-mapper song groups</div>
                    <div style="color:#64748b;font-size:0.875rem;margin-top:0.25rem;">Simpler cases for learning</div>
                </div>
                <div style="padding:1rem;background:#f8fafc;border-radius:8px;">
                    <div style="font-weight:600;margin-bottom:0.5rem;">Test Set</div>
                    <div style="color:#64748b;font-size:0.875rem;">271 mapsets from 3+ mapper song groups</div>
                    <div style="color:#64748b;font-size:0.875rem;margin-top:0.25rem;">Richer variation, never seen during training</div>
                </div>
            </div>
        </section>

        <div id="comparison-chart" style="background:#fff;border-radius:12px;padding:2rem;margin-bottom:2rem;box-shadow:0 1px 3px rgba(0,0,0,0.05);"></div>

        <section style="background:#fff;border-radius:12px;padding:1.5rem;margin-bottom:2rem;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
            <h2 style="margin-bottom:1rem;">Results</h2>
            <div id="results-details"></div>
            <div id="verdict-box" style="margin-top:1.5rem;padding:1.5rem;border-radius:8px;"></div>
        </section>

        <section style="background:#fff;border-radius:12px;padding:1.5rem;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
            <h2 style="margin-bottom:1rem;">Interpretation</h2>
            <p style="color:#64748b;margin-bottom:1rem;">
                The latent cosine similarity <strong style="color:#1e293b;">holds</strong> on the held-out test set,
                actually improving by +3.9%. This confirms that the VAE learned generalizable perceptual structure
                rather than memorizing the training set.
            </p>
            <p style="color:#64748b;">
                The original finding (0.774 cosine similarity in latent space vs 0.603 in raw space) was
                <strong style="color:#1e293b;">conservative</strong> — the true generalization performance is stronger.
            </p>
        </section>

        <footer style="text-align:center;margin-top:2rem;padding-top:2rem;border-top:1px solid #e2e8f0;color:#64748b;font-size:0.875rem;">
            <p>Part D: Cross-Validation Analysis</p>
        </footer>
    </div>

    <script>
        d3.json('data/cv_comparison.json').then(data => {
            // Comparison chart
            const chartData = [
                { label: 'Original\n(all 850)', value: data.original.full_cosine_mean, pairs: data.original.pairs },
                { label: 'CV Test\n(held-out 271)', value: data.cv_test.full_cosine_mean, pairs: data.cv_test.pairs }
            ];

            const container = d3.select('#comparison-chart');
            const margin = { top: 60, right: 40, bottom: 60, left: 200 };
            const width = 700 - margin.left - margin.right;
            const height = 250 - margin.top - margin.bottom;

            const svg = container.append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const y = d3.scaleBand()
                .domain(chartData.map(d => d.label))
                .range([0, height])
                .padding(0.3);

            const x = d3.scaleLinear()
                .domain([0, 1])
                .range([0, width]);

            svg.selectAll('.bar')
                .data(chartData)
                .join('rect')
                .attr('class', 'bar')
                .attr('y', d => y(d.label))
                .attr('x', 0)
                .attr('width', d => x(d.value))
                .attr('height', y.bandwidth())
                .attr('fill', '#2563eb');

            svg.append('g')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '14px')
                .style('font-weight', '500');

            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(5))
                .selectAll('text')
                .style('font-size', '12px');

            svg.append('text')
                .attr('x', width/2)
                .attr('y', -30)
                .attr('text-anchor', 'middle')
                .style('font-size', '16px')
                .style('font-weight', '600')
                .text('Full Cosine Similarity Comparison');

            svg.append('text')
                .attr('x', width/2)
                .attr('y', height + 50)
                .attr('text-anchor', 'middle')
                .style('font-size', '14px')
                .style('fill', '#64748b')
                .text('Cross-mapper cosine similarity');

            // Value labels
            svg.selectAll('.value-label')
                .data(chartData)
                .join('text')
                .attr('x', d => x(d.value) + 10)
                .attr('y', d => y(d.label) + y.bandwidth() / 2)
                .attr('dy', '0.35em')
                .style('font-size', '16px')
                .style('font-weight', '700')
                .style('fill', '#1e293b')
                .text(d => d.value.toFixed(3));

            // Results details
            const detailsContainer = d3.select('#results-details');
            detailsContainer.html(`
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1.5rem;">
                    <div>
                        <div style="color:#64748b;font-size:0.875rem;margin-bottom:0.25rem;">Δ Cosine (absolute)</div>
                        <div style="font-size:1.5rem;font-weight:700;color:#10b981;">+${data.delta.cosine_absolute.toFixed(4)}</div>
                    </div>
                    <div>
                        <div style="color:#64748b;font-size:0.875rem;margin-bottom:0.25rem;">Δ Cosine (percent)</div>
                        <div style="font-size:1.5rem;font-weight:700;color:#10b981;">+${data.delta.cosine_percent.toFixed(1)}%</div>
                    </div>
                    <div>
                        <div style="color:#64748b;font-size:0.875rem;margin-bottom:0.25rem;">Test pairs analyzed</div>
                        <div style="font-size:1.5rem;font-weight:700;color:#2563eb;">${data.cv_test.pairs}</div>
                    </div>
                </div>
            `);

            // Verdict box
            const verdictContainer = d3.select('#verdict-box');
            const verdictText = data.delta.verdict.split('—')[1].trim();

            verdictContainer
                .style('background', '#d1fae5')
                .style('border', '2px solid #10b981')
                .html(`
                    <div style="display:flex;align-items:center;gap:1rem;">
                        <div style="font-size:2rem;">✓</div>
                        <div>
                            <div style="font-weight:700;font-size:1.25rem;color:#065f46;margin-bottom:0.25rem;">Verdict</div>
                            <div style="color:#047857;">${verdictText}</div>
                        </div>
                    </div>
                `);
        });
    </script>
</body>
</html>
